###############################################################################
# OpenWRTå›ºä»¶è‡ªåŠ¨åŒ–ç¼–è¯‘å·¥ä½œæµ
# åŠŸèƒ½ï¼šè‡ªåŠ¨ç¼–è¯‘åŒ…å«å’Œä¸åŒ…å«gecoosåº”ç”¨çš„ä¸¤ç§å›ºä»¶å˜ä½“
# è§¦å‘æ–¹å¼ï¼šå®šæ—¶è§¦å‘(æ¯æ—¥UTC 22:00) + æ‰‹åŠ¨è§¦å‘
###############################################################################

name: CWRT-ALL

on:
  # å®šæ—¶è§¦å‘é…ç½® (åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹)
  schedule:
    - cron: '0 22 * * *'  # æ³¨æ„ï¼šcronè¡¨è¾¾å¼éœ€è¦å¼•å·
  
  # æ‰‹åŠ¨è§¦å‘é…ç½®
  workflow_dispatch:
    inputs:
      PACKAGE:
        description: 'ğŸ“¦ æ‰‹åŠ¨è°ƒæ•´æ’ä»¶åŒ…(å¤šä¸ªè¯·ç”¨æ¢è¡Œç¬¦åˆ†éš”)'
        required: false
        type: string
      TEST:
        description: 'ğŸ§ª ä»…è¾“å‡ºé…ç½®æ–‡ä»¶ä¸ç¼–è¯‘å›ºä»¶'
        default: 'false'
        required: false
        type: boolean

env:
  # ä½¿ç”¨GitHubè‡ªåŠ¨ç”Ÿæˆçš„ä¸´æ—¶token
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# æœ€å°åŒ–æ‰€éœ€æƒé™
permissions:
  contents: write  # ç”¨äºåˆ›å»ºrelease
  workflows: write # ç”¨äºæ¸…ç†workflowè¿è¡Œè®°å½•

jobs:
  ##############################################
  # æ¸…ç†ä»»åŠ¡ï¼šåˆ é™¤æ—§ç‰ˆæœ¬å’Œworkflowè®°å½•
  # æ³¨æ„ï¼šä¼šä¿ç•™3ä¸ªæœ€æ–°releaseå’Œ7å¤©å†…è®°å½•
  ##############################################
  cleanup:
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ—‘ï¸ æ¸…ç†å†å²ç‰ˆæœ¬
        uses: ophub/delete-releases-workflows@main
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          delete_releases: true
          releases_keep_latest: 3    # é‡è¦ï¼šè‡³å°‘ä¿ç•™3ä¸ªç‰ˆæœ¬ç”¨äºå›æ»š
          delete_tags: true          # åŒæ­¥åˆ é™¤å…³è”tag
          delete_workflows: true     
          workflows_keep_day: 7      # ä¿ç•™7å¤©è¿è¡Œè®°å½•

  ##############################################
  # ç¼–è¯‘ä»»åŠ¡ï¼šå¹¶è¡Œæ„å»ºä¸¤ä¸ªå›ºä»¶å˜ä½“
  # å˜ä½“1ï¼šåŒ…å«luci-app-gecoosac
  # å˜ä½“2ï¼šä¸åŒ…å«luci-app-gecoosac
  ##############################################
  config:
    needs: cleanup  # ä¾èµ–æ¸…ç†ä»»åŠ¡å®Œæˆ
    name: ${{ matrix.CONFIG }}-${{ matrix.BUILD_VARIANT.NAME }}
    
    # å¹¶è¡Œæ‰§è¡Œç­–ç•¥é…ç½®
    strategy:
      fail-fast: false  # æŸä¸ªå˜ä½“å¤±è´¥ä¸å½±å“å…¶ä»–å˜ä½“
      matrix:
        # è®¾å¤‡å‹å·çŸ©é˜µï¼ˆå¯æ‰©å±•å¤šä¸ªè®¾å¤‡ï¼‰
        CONFIG: [MT7981]  
        
        # æ„å»ºå˜ä½“å®šä¹‰
        BUILD_VARIANT: 
          - { 
              NAME: "with-gecoos", 
              EXTRA_PACKAGE: "CONFIG_PACKAGE_luci-app-gecoosac=y" 
            }
          - { 
              NAME: "without-gecoos", 
              EXTRA_PACKAGE: "CONFIG_PACKAGE_luci-app-gecoosac=n" 
            }
        
        # æºç ä»“åº“é…ç½®ï¼ˆå¯æ‰©å±•å¤šä¸ªæºç åˆ†æ”¯ï¼‰
        REPO_INFO:
          - { 
              SOURCE: "padavanonly/immortalwrt-mt798x-24.10", 
              BRANCH: "2410" 
            }

    # è°ƒç”¨å…±äº«ç¼–è¯‘æµç¨‹
    uses: ./.github/workflows/WRT-CORE.yml
    with:
      # åŸºç¡€é…ç½®
      WRT_CONFIG: ${{ matrix.CONFIG }}      # è®¾å¤‡å‹å·
      WRT_THEME: argon                      # é»˜è®¤ä¸»é¢˜
      WRT_NAME: YT                          # è®¾å¤‡ä¸»æœºå
      
      # ç½‘ç»œé…ç½®ï¼ˆå¯†ç åº”ä»secretsè·å–ï¼‰
      WRT_SSID: CMCC                        # WiFiåç§°
      WRT_WORD: ${{ secrets.WIFI_PASSWORD || '12345678' }}  # ä¼˜å…ˆä½¿ç”¨secret
      WRT_IP: 10.0.100.1                    # ç®¡ç†åœ°å€
      WRT_PW: ${{ secrets.ADMIN_PASSWORD || 'æ— ' }}  # ç®¡ç†å¯†ç 
      
      # æºç é…ç½®
      WRT_REPO: https://github.com/${{ matrix.REPO_INFO.SOURCE }}.git
      WRT_BRANCH: ${{ matrix.REPO_INFO.BRANCH }}
      WRT_SOURCE: ${{ matrix.REPO_INFO.SOURCE }}
      
      # åŠ¨æ€åŒ…é…ç½®
      WRT_PACKAGE: |
        # è‡ªåŠ¨æ’å…¥å˜ä½“ç‰¹å®šé…ç½®
        ${{ matrix.BUILD_VARIANT.EXTRA_PACKAGE }}
        
        # æ‰‹åŠ¨è¾“å…¥çš„é¢å¤–åŒ…é…ç½®
        ${{ inputs.PACKAGE }}
      
      # æµ‹è¯•æ¨¡å¼å¼€å…³
      WRT_TEST: ${{ inputs.TEST }}
